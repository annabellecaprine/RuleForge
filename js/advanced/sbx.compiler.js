(function (root) {
  'use strict';
  // SBX compiler for JanitorAI Advanced Script (ES5).
  // Produces runnable JS code from appState (lists/derived/blocks).
  var SBX = (root.SBX = root.SBX || {});
  SBX.compiler = SBX.compiler || {};

  function isArr(x) { return Object.prototype.toString.call(x) === '[object Array]'; }

  function validate(appState) {
    appState = appState || {};
    var blocks = isArr(appState.blocks) ? appState.blocks : [];
    var msgs = [];
    var hasIf = false, hasElse = false;

    for (var i = 0; i < blocks.length; i++) {
      var b = blocks[i] || {};
      var lbl = b.label || ('block #' + (i + 1));

      if (b.type === 'if') { hasIf = true; hasElse = false; }
      if (b.type === 'elseif' && !hasIf) msgs.push('ELSE IF without a preceding IF near ' + lbl + '.');
      if (b.type === 'else') {
        if (!hasIf) msgs.push('ELSE without a preceding IF near ' + lbl + '.');
        if (hasElse) msgs.push('Multiple ELSE blocks in the same IF/ELSE chain near ' + lbl + '.');
        hasElse = true;
      }
      if ((b.type === 'if' || b.type === 'elseif') && (!b.conditions || !b.conditions.length)) {
        msgs.push("IF/ELSE IF block '" + lbl + "' has no conditions; it will always be true.");
      }
      if (!b.actions || !b.actions.length) msgs.push("Block '" + lbl + "' has no actions and does nothing.");
    }
    return msgs;
  }

  function generate(appState) {
    appState = appState || {};
    appState.lists = isArr(appState.lists) ? appState.lists : [];
    appState.derived = isArr(appState.derived) ? appState.derived : [];
    appState.blocks = isArr(appState.blocks) ? appState.blocks : [];

    var lines = [];
    var i;

    lines.push('// Generated by SiteBuilderX Advanced (SBX)');
    lines.push('// Paste into JanitorAI Advanced Script.');
    lines.push('');

    // Lists
    if (appState.lists.length) {
      for (i = 0; i < appState.lists.length; i++) {
        var list = appState.lists[i] || {};
        var lid = String(list.id || '');
        if (!lid) continue;
        var items = isArr(list.items) ? list.items : [];
        lines.push('// List: ' + (list.label || lid));
        lines.push('var ' + lid + ' = ' + JSON.stringify(items) + ';');
      }
      lines.push('');
    } else {
      lines.push('// No lists defined.');
      lines.push('');
    }

    // Helpers (self-contained; avoids external deps)
    lines.push('// Helpers');
    lines.push('function __sbx_isArr(x){ return Object.prototype.toString.call(x)==="[object Array]"; }');
    lines.push('function __sbx_norm(s){ s=String(s==null?"":s); return s.toLowerCase(); }');
    lines.push('function __sbx_last_messages(ctx){');
    lines.push('  var a=(ctx&&ctx.chat&&ctx.chat.last_messages)?ctx.chat.last_messages:[];');
    lines.push('  // Support both [{message:".."}] and [".."]');
    lines.push('  if (__sbx_isArr(a) && a.length && typeof a[0]==="object" && a[0] && a[0].message!=null){');
    lines.push('    var out=[]; for (var i=0;i<a.length;i++) out.push(String(a[i].message||"")); return out;');
    lines.push('  }');
    lines.push('  if (!a||!a.length){');
    lines.push('    var lm=(ctx&&ctx.chat&&typeof ctx.chat.last_message==="string")?ctx.chat.last_message:"";');
    lines.push('    if (lm) a=[lm];');
    lines.push('  }');
    lines.push('  // ensure strings');
    lines.push('  var out2=[]; if (__sbx_isArr(a)) for (var j=0;j<a.length;j++) out2.push(String(a[j]||""));');
    lines.push('  return out2;');
    lines.push('}');
    lines.push('function __sbx_norm_history(arr,maxN){');
    lines.push('  var out=[]; if(!arr) return out;');
    lines.push('  var start=0; if(typeof maxN==="number"&&maxN>0&&arr.length>maxN) start=arr.length-maxN;');
    lines.push('  for (var i=start;i<arr.length;i++) out.push(__sbx_norm(arr[i]));');
    lines.push('  return out;');
    lines.push('}');
    lines.push('function __sbx_countMatches(normHistory,list,windowSize){');
    lines.push('  list=list||[]; var start=0;');
    lines.push('  if(typeof windowSize==="number"&&windowSize>0&&normHistory.length>windowSize) start=normHistory.length-windowSize;');
    lines.push('  var count=0;');
    lines.push('  for (var i=start;i<normHistory.length;i++){');
    lines.push('    var msg=normHistory[i]||"";');
    lines.push('    for (var j=0;j<list.length;j++){');
    lines.push('      var kw=__sbx_norm(list[j]);');
    lines.push('      if(kw && msg.indexOf(kw)!==-1){ count++; break; }');
    lines.push('    }');
    lines.push('  }');
    lines.push('  return count;');
    lines.push('}');
    lines.push('function __sbx_listAny(list,target){');
    lines.push('  if(!list||!list.length) return false;');
    lines.push('  if(typeof target==="string"){');
    lines.push('    var t=__sbx_norm(target);');
    lines.push('    for(var i=0;i<list.length;i++) if(t.indexOf(__sbx_norm(list[i]))!==-1) return true;');
    lines.push('  } else if(__sbx_isArr(target)){');
    lines.push('    for(var ii=0;ii<target.length;ii++){');
    lines.push('      var msg=__sbx_norm(target[ii]);');
    lines.push('      for(var j=0;j<list.length;j++) if(msg.indexOf(__sbx_norm(list[j]))!==-1) return true;');
    lines.push('    }');
    lines.push('  }');
    lines.push('  return false;');
    lines.push('}');
    lines.push('function __sbx_historyContains(normHistory,txt,windowSize){');
    lines.push('  txt=String(txt==null?"":txt); if(!txt) return false;');
    lines.push('  var start=0; if(typeof windowSize==="number"&&windowSize>0&&normHistory.length>windowSize) start=normHistory.length-windowSize;');
    lines.push('  for (var i=start;i<normHistory.length;i++){ if (String(normHistory[i]||"").indexOf(txt)!==-1) return true; }');
    lines.push('  return false;');
    lines.push('}');
    lines.push('function __sbx_listAnyNegation(list,target){');
    lines.push('  if(!list||!list.length) return false;');
    lines.push('  var tVals=[];');
    lines.push('  if(typeof target==="string") tVals=[__sbx_norm(target)];');
    lines.push('  else if(__sbx_isArr(target)) tVals=target;');
    lines.push('  else return false;');
    lines.push('  var negs=["not","no","never","don\\x27t","dont","won\\x27t","wont","can\\x27t","cant","without"];');
    lines.push('  for (var i=0;i<tVals.length;i++){');
    lines.push('    var hay=String(tVals[i]||"");');
    lines.push('    for (var j=0;j<list.length;j++){');
    lines.push('      var needle=__sbx_norm(list[j]); if(!needle) continue;');
    lines.push('      var idx=-1;');
    lines.push('      while((idx=hay.indexOf(needle,idx+1))!==-1){');
    lines.push('        var pre=hay.substring(0,idx); var isNeg=false;');
    lines.push('        for (var k=0;k<negs.length;k++){');
    lines.push('          var re=new RegExp("(?:^|[\\\\s\\\\W])"+negs[k]+"[\\\\s\\\\W]*$");');
    lines.push('          if(re.test(pre)){ isNeg=true; break; }');
    lines.push('        }');
    lines.push('        if(!isNeg) return true;');
    lines.push('      }');
    lines.push('    }');
    lines.push('  }');
    lines.push('  return false;');
    lines.push('}');
    lines.push('');

    // Context
    lines.push('// Context');
    lines.push('var lastMessages = __sbx_last_messages(context);');
    lines.push('var normHistory = __sbx_norm_history(lastMessages, 50);');
    lines.push('');

    // Derived
    lines.push('// Derived values (recomputed every run)');
    lines.push('var derived = {};');
    if (appState.derived.length) {
      for (i = 0; i < appState.derived.length; i++) {
        var d = appState.derived[i] || {};
        var key = String(d.key || '');
        var listId = String(d.listId || '');
        var ws = (typeof d.windowSize === 'number') ? d.windowSize : parseInt(d.windowSize, 10);
        if (!key || !listId) continue;
        if (isNaN(ws) || ws <= 0) ws = 10;
        lines.push('derived[' + JSON.stringify(key) + '] = __sbx_countMatches(normHistory, ' + listId + ', ' + ws + ');');
      }
    } else {
      lines.push('// (none)');
    }
    lines.push('');

    // Action helpers
    lines.push('// Action helpers (safe append)');
    lines.push('function __sbx_append(path, txt){');
    lines.push('  txt=String(txt==null?"":txt); if(!txt) return;');
    lines.push('  context.character = context.character || {};');
    lines.push('  var cur = String(context.character[path]==null?"":context.character[path]);');
    lines.push('  if (cur && cur.charAt(cur.length-1)!=="\\n") cur += "\\n";');
    lines.push('  context.character[path] = cur + txt;');
    lines.push('}');
    lines.push('function __sbx_appendRandom(path, list){');
    lines.push('  if(!list||!list.length) return;');
    lines.push('  var idx=Math.floor(Math.random()*list.length);');
    lines.push('  __sbx_append(path, list[idx]);');
    lines.push('}');
    lines.push('');

    // Blocks
    lines.push('// Trigger blocks');
    lines.push('(function(){');

    function condExpr(c) {
      if (!c) return 'true';
      var t = String(c.type || '');
      var op = String(c.op || '>=');
      var safeOps = { '>': 1, '>=': 1, '<': 1, '<=': 1, '==': 1, '!=': 1, 'every': 1 };
      if (!safeOps[op]) op = '>=';

      var th = parseFloat(c.threshold);
      if (isNaN(th)) th = 0;

      if (t === 'anyInList' || t === 'noneInList') {
        var lid = String(c.listId || '');
        if (!lid) return (t === 'noneInList' ? 'true' : 'false');
        var src = (c.source === 'normHistory') ? 'normHistory' : '__sbx_norm((context.chat && context.chat.last_message) || "")';
        if (c.negationGuard && t === 'anyInList') return '__sbx_listAnyNegation(' + lid + ', ' + src + ')';
        var check = '__sbx_listAny(' + lid + ', ' + src + ')';
        return (t === 'noneInList') ? ('!' + check) : check;
      }

      if (t === 'historyContainsList' || t === 'countInHistory') {
        var lid2 = String(c.listId || '');
        var ws2 = parseInt(c.windowSize, 10);
        if (isNaN(ws2) || ws2 <= 0) ws2 = 5;
        if (!lid2) return 'false';
        return '(__sbx_countMatches(normHistory, ' + lid2 + ', ' + ws2 + ') ' + op + ' ' + th + ')';
      }

      if (t === 'messageCountComparison') {
        var mc = '(context.chat && context.chat.chat_metadata && context.chat.chat_metadata.public_message_count)';
        if (op === 'every') return '((' + mc + ' || 0) > 0 && ((' + mc + ' || 0) % ' + th + ' === 0))';
        return '((' + mc + ' || 0) ' + op + ' ' + th + ')';
      }

      if (t === 'messageHistoryContains') {
        var ws3 = parseInt(c.windowSize, 10);
        if (isNaN(ws3) || ws3 <= 0) ws3 = 5;
        var txt = JSON.stringify(String(c.text || '').toLowerCase());
        return '(__sbx_historyContains(normHistory, ' + txt + ', ' + ws3 + '))';
      }

      if (t === 'personalityContains' || t === 'scenarioContains') {
        var txt2 = JSON.stringify(String(c.text || '').toLowerCase());
        var target = (t === 'personalityContains') ? '(context.character && context.character.personality || "")' : '(context.character && context.character.scenario || "")';
        return '(' + target + '.toLowerCase().indexOf(' + txt2 + ') !== -1)';
      }

      if (t === 'memoryNumberComparison') {
        var k = JSON.stringify(String(c.memKey || ''));
        return '(((context.character && context.character.memory && parseFloat(context.character.memory[' + k + '])) || 0) ' + op + ' ' + th + ')';
      }

      if (t === 'memoryStringContains') {
        var k2 = JSON.stringify(String(c.memKey || ''));
        var txt3 = JSON.stringify(String(c.text || '').toLowerCase());
        return '(((context.character && context.character.memory && String(context.character.memory[' + k2 + '] || "")) || "").toLowerCase().indexOf(' + txt3 + ') !== -1)';
      }

      if (t === 'derivedNumberComparison') {
        var dk = JSON.stringify(String(c.derivedKey || ''));
        return '(((derived[' + dk + '] || 0) ' + op + ' ' + th + '))';
      }

      if (t === 'randomChance') return '(Math.random() * 100 < ' + th + ')';

      return 'true';
    }

    function condNodeExpr(node) {
      if (!node) return 'true';
      if (node.nodeType === 'group' || node.kind === 'group') {
        var join = String(node.join || 'and').toLowerCase() === 'or' ? 'or' : 'and';
        var items = isArr(node.items) ? node.items : [];
        var parts = [];
        for (var i = 0; i < items.length; i++) parts.push(condNodeExpr(items[i]));
        var expr = parts.length ? parts.join(join === 'and' ? ' && ' : ' || ') : 'true';
        if (node.not) expr = '!' + '(' + expr + ')';
        return '(' + expr + ')';
      }
      var e = condExpr(node);
      if (node.not) e = '!' + '(' + e + ')';
      return '(' + e + ')';
    }

    function actionStmt(a) {
      if (!a) return '';
      var t = String(a.type || '');
      var txt = String(a.text == null ? '' : a.text);

      if (t === 'appendPersonality') return '__sbx_append("personality", ' + JSON.stringify(txt) + ');';
      if (t === 'appendScenario') return '__sbx_append("scenario", ' + JSON.stringify(txt) + ');';
      if (t === 'appendExampleDialogs') return '__sbx_append("example_dialogs", ' + JSON.stringify(txt) + ');';

      if (t === 'appendRandomFromList') {
        var tgt = (a.target === 'appendScenario') ? 'scenario' : ((a.target === 'appendExampleDialogs') ? 'example_dialogs' : 'personality');
        var lid = String(a.listId || '');
        if (lid) return '__sbx_appendRandom("' + tgt + '", ' + lid + ');';
        return '';
      }

      if (t === 'memoryNumeric' || t === 'memoryString') {
        var k = JSON.stringify(String(a.memKey || ''));
        var mode = String(a.mode || 'set');
        var val = (t === 'memoryNumeric') ? parseFloat(txt) : txt;
        if (t === 'memoryNumeric' && isNaN(val)) val = 0;
        var valStr = JSON.stringify(val);
        var line = 'context.character = context.character || {}; context.character.memory = context.character.memory || {}; ';
        if (mode === 'append' && t === 'memoryString') {
          line += 'context.character.memory[' + k + '] = (context.character.memory[' + k + '] || "") + ' + valStr + ';';
        } else if (mode === 'append' && t === 'memoryNumeric') {
          line += 'context.character.memory[' + k + '] = (parseFloat(context.character.memory[' + k + ']) || 0) + ' + valStr + ';';
        } else {
          line += 'context.character.memory[' + k + '] = ' + valStr + ';';
        }
        return line;
      }

      return '';
    }

    for (i = 0; i < appState.blocks.length; i++) {
      var b = appState.blocks[i] || {};
      var btype = String(b.type || 'if');
      var join = (String(b.join || 'AND').toUpperCase() === 'OR') ? 'OR' : 'AND';
      var conds = isArr(b.conditions) ? b.conditions : [];
      var acts = isArr(b.actions) ? b.actions : [];

      var expr = 'true';
      if (btype !== 'else') {
        if (!conds.length) expr = 'true';
        else {
          var parts = [];
          for (var ci = 0; ci < conds.length; ci++) parts.push(condNodeExpr(conds[ci]));
          expr = parts.join(join === 'AND' ? ' && ' : ' || ');
        }
      }

      if (btype === 'if') lines.push('  if (' + expr + ') {');
      else if (btype === 'elseif') lines.push('  else if (' + expr + ') {');
      else lines.push('  else {');

      for (var ai = 0; ai < acts.length; ai++) {
        var st = actionStmt(acts[ai]);
        if (st) lines.push('    ' + st);
      }
      lines.push('  }');
    }

    lines.push('})();');
    lines.push('');

    var msgs = validate(appState);
    if (msgs.length) {
      lines.unshift('// WARNINGS:');
      for (i = 0; i < msgs.length; i++) lines.unshift('// - ' + msgs[i]);
      lines.unshift('//');
    }

    return lines.join('\n');
  }

  SBX.compiler.validate = validate;
  SBX.compiler.generate = generate;
})(window);
